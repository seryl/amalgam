name: Build and Push Docker Images with Nix

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      push:
        description: 'Push images to registry'
        type: boolean
        default: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # For ghcr.io

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build Docker images with Nix
        run: |
          echo "Building amalgam compiler image..."
          nix build .#amalgam-image

          echo "Building packages distribution image..."
          nix build .#packages-image

          echo "Building layered image (better caching)..."
          nix build .#amalgam-layered

      - name: Load images into Docker
        run: |
          echo "Loading amalgam image..."
          docker load < result

          # The result symlink points to the last built item
          # We need to load each separately
          docker load < $(nix build .#amalgam-image --print-out-paths)
          docker load < $(nix build .#packages-image --print-out-paths)

      - name: Tag images for registry
        id: meta
        run: |
          # Determine tags based on trigger
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            TAGS="latest,$VERSION"
          else
            TAGS="latest,sha-${{ github.sha }}"
          fi

          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request' && (github.event.inputs.push == 'true' || github.event_name == 'release')
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push images to ghcr.io
        if: github.event_name != 'pull_request' && (github.event.inputs.push == 'true' || github.event_name == 'release')
        run: |
          # Get the image names from the built images
          AMALGAM_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep amalgam-compiler | head -1)
          PACKAGES_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep nickel-packages | head -1)

          # Tag and push amalgam compiler
          for TAG in $(echo "${{ steps.meta.outputs.tags }}" | tr ',' ' '); do
            docker tag $AMALGAM_IMAGE ghcr.io/${{ github.repository }}/amalgam:$TAG
            docker push ghcr.io/${{ github.repository }}/amalgam:$TAG
          done

          # Tag and push packages
          for TAG in $(echo "${{ steps.meta.outputs.tags }}" | tr ',' ' '); do
            docker tag $PACKAGES_IMAGE ghcr.io/${{ github.repository }}/packages:$TAG
            docker push ghcr.io/${{ github.repository }}/packages:$TAG
          done

          echo "âœ… Images pushed to ghcr.io/${{ github.repository }}"

      - name: Push using Nix helper (alternative method)
        if: false  # Enable this to use the Nix-based push script
        env:
          REGISTRY: ghcr.io
          REPO: ${{ github.repository }}
          TAG: ${{ steps.meta.outputs.tags }}
          REGISTRY_USER: ${{ github.actor }}
          REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          nix run .#push-with-skopeo

  # Build multi-platform images
  build-multiplatform:
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4

      - name: Setup QEMU for cross-compilation
        uses: docker/setup-qemu-action@v3

      - name: Build for ${{ matrix.platform }}
        run: |
          # This would require cross-compilation support in the flake
          echo "Building for ${{ matrix.platform }}..."
          # nix build .#amalgam-image-${{ matrix.platform }}

  # Streaming image build (most efficient)
  build-stream:
    runs-on: ubuntu-latest
    if: false  # Enable when you add streaming support
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v4

      - name: Stream image directly to registry
        env:
          REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Stream the image directly without loading into Docker
          nix build .#amalgam-stream --print-out-paths | \
            skopeo copy docker-archive:/dev/stdin \
            docker://ghcr.io/${{ github.repository }}/amalgam:stream \
            --dest-username ${{ github.actor }} \
            --dest-password $REGISTRY_PASSWORD
